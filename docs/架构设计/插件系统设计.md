# 插件系统设计

> 本文档描述 PrismaX 的插件系统架构设计

---

## 概述

插件系统允许第三方开发者扩展 PrismaX 的功能，包括：

- 自定义工具（Tool）
- 自定义模型提供商
- 自定义 UI 组件
- 自定义数据处理器

---

## 插件架构

```
+-------------------------------------------------------------------------+
|                           PrismaX 插件系统                               |
+-------------------------------------------------------------------------+
|                                                                         |
|  +-------------------+     +-------------------+     +-------------------+
|  |   插件注册表       |     |   插件加载器       |     |   插件沙箱        |
|  |   (Registry)      |     |   (Loader)        |     |   (Sandbox)       |
|  +-------------------+     +-------------------+     +-------------------+
|           |                        |                        |           |
|           v                        v                        v           |
|  +-------------------------------------------------------------------+  |
|  |                         插件 API 层                                |  |
|  |  +-------------+  +-------------+  +-------------+  +-------------+ |
|  |  | Tool API    |  | Model API   |  | UI API      |  | Data API    | |
|  |  +-------------+  +-------------+  +-------------+  +-------------+ |
|  +-------------------------------------------------------------------+  |
|                                                                         |
+-------------------------------------------------------------------------+
```

---

## 插件定义

### 插件清单（manifest.json）

```json
{
  "name": "web-search",
  "version": "1.0.0",
  "displayName": "Web Search",
  "description": "Search the web using various search engines",
  "author": "PrismaX Team",
  "homepage": "https://github.com/prismax/plugin-web-search",
  "license": "MIT",
  "main": "dist/index.js",
  "prismax": {
    "minVersion": "1.0.0",
    "permissions": [
      "network",
      "storage"
    ],
    "provides": {
      "tools": ["web_search", "url_fetch"],
      "settings": true
    }
  }
}
```

### 插件入口

```typescript
// index.ts
import { Plugin, PluginContext } from '@prismax/plugin-sdk';

export default class WebSearchPlugin implements Plugin {
  name = 'web-search';
  version = '1.0.0';

  private context: PluginContext;

  async onLoad(context: PluginContext): Promise<void> {
    this.context = context;

    // 注册工具
    context.registerTool({
      name: 'web_search',
      description: 'Search the web for information',
      parameters: {
        type: 'object',
        properties: {
          query: {
            type: 'string',
            description: 'The search query',
          },
          engine: {
            type: 'string',
            enum: ['google', 'bing', 'duckduckgo'],
            default: 'google',
          },
        },
        required: ['query'],
      },
      execute: this.executeSearch.bind(this),
    });

    // 注册设置页面
    context.registerSettings({
      component: () => import('./SettingsPage'),
    });
  }

  async onUnload(): Promise<void> {
    // 清理资源
  }

  private async executeSearch(params: {
    query: string;
    engine?: string;
  }): Promise<string> {
    const { query, engine = 'google' } = params;
    // 执行搜索逻辑
    const results = await this.search(query, engine);
    return JSON.stringify(results);
  }

  private async search(query: string, engine: string) {
    // 搜索实现
  }
}
```

---

## 插件 API

### Tool API

```typescript
interface ToolDefinition {
  // 工具名称（唯一标识）
  name: string;

  // 工具描述（用于 AI 理解）
  description: string;

  // 参数定义（JSON Schema）
  parameters: JSONSchema;

  // 执行函数
  execute: (params: unknown) => Promise<string>;

  // 可选：是否需要用户确认
  requireConfirmation?: boolean;

  // 可选：超时时间（毫秒）
  timeout?: number;
}

// 注册工具
context.registerTool(tool: ToolDefinition): void;

// 注销工具
context.unregisterTool(name: string): void;
```

### Model API

```typescript
interface ModelProviderDefinition {
  // 提供商 ID
  id: string;

  // 显示名称
  displayName: string;

  // 图标
  icon?: string;

  // 支持的功能
  capabilities: {
    chat: boolean;
    streaming: boolean;
    embedding: boolean;
    vision: boolean;
  };

  // 创建客户端
  createClient: (config: ProviderConfig) => AIProvider;

  // 配置表单
  configSchema: JSONSchema;
}

// 注册模型提供商
context.registerModelProvider(provider: ModelProviderDefinition): void;
```

### UI API

```typescript
interface UIExtension {
  // 扩展点
  slot: 'sidebar' | 'toolbar' | 'settings' | 'message-actions';

  // 组件
  component: () => Promise<{ default: React.ComponentType }>;

  // 优先级
  priority?: number;
}

// 注册 UI 扩展
context.registerUIExtension(extension: UIExtension): void;

// 显示通知
context.showNotification(options: NotificationOptions): void;

// 显示对话框
context.showDialog(options: DialogOptions): Promise<unknown>;
```

### Storage API

```typescript
// 插件专用存储
interface PluginStorage {
  get<T>(key: string): Promise<T | null>;
  set<T>(key: string, value: T): Promise<void>;
  delete(key: string): Promise<void>;
  clear(): Promise<void>;
}

// 获取存储实例
const storage = context.getStorage();
```

### Network API

```typescript
// 网络请求（受沙箱限制）
interface NetworkAPI {
  fetch(url: string, options?: RequestInit): Promise<Response>;
}

// 获取网络 API
const network = context.getNetwork();
```

---

## 插件加载器

### 加载流程

```
1. 扫描插件目录
2. 读取 manifest.json
3. 验证插件签名（可选）
4. 检查权限
5. 创建沙箱环境
6. 加载插件代码
7. 调用 onLoad
8. 注册到插件注册表
```

### 实现

```typescript
// plugins/loader.ts
class PluginLoader {
  private plugins: Map<string, LoadedPlugin> = new Map();
  private registry: PluginRegistry;

  async loadPlugin(pluginPath: string): Promise<void> {
    // 1. 读取清单
    const manifest = await this.readManifest(pluginPath);

    // 2. 验证
    await this.validatePlugin(manifest);

    // 3. 检查权限
    const permissions = await this.checkPermissions(manifest);
    if (!permissions.granted) {
      throw new Error(`Plugin ${manifest.name} requires permissions: ${permissions.required}`);
    }

    // 4. 创建上下文
    const context = this.createContext(manifest);

    // 5. 加载代码
    const PluginClass = await this.loadCode(pluginPath, manifest);

    // 6. 实例化
    const plugin = new PluginClass();

    // 7. 调用 onLoad
    await plugin.onLoad(context);

    // 8. 注册
    this.plugins.set(manifest.name, {
      manifest,
      instance: plugin,
      context,
    });

    this.registry.register(manifest.name, plugin);
  }

  async unloadPlugin(name: string): Promise<void> {
    const loaded = this.plugins.get(name);
    if (!loaded) return;

    // 调用 onUnload
    await loaded.instance.onUnload?.();

    // 清理注册的内容
    loaded.context.cleanup();

    // 从注册表移除
    this.registry.unregister(name);

    this.plugins.delete(name);
  }

  private createContext(manifest: PluginManifest): PluginContext {
    return new PluginContextImpl(manifest, this.registry);
  }
}
```

---

## 插件沙箱

### 安全限制

| 限制项 | 说明 |
|--------|------|
| 文件系统 | 只能访问插件目录和用户授权的目录 |
| 网络 | 只能访问白名单域名 |
| 系统 API | 禁止访问敏感系统 API |
| 内存 | 限制内存使用 |
| CPU | 限制执行时间 |

### 实现方式

```typescript
// plugins/sandbox.ts
class PluginSandbox {
  private vm: VM;

  constructor(manifest: PluginManifest) {
    this.vm = new VM({
      timeout: 30000, // 30 秒超时
      sandbox: this.createSandbox(manifest),
    });
  }

  private createSandbox(manifest: PluginManifest) {
    const sandbox: Record<string, unknown> = {
      // 基础 API
      console: this.createSafeConsole(),
      setTimeout: this.createSafeTimeout(),
      setInterval: this.createSafeInterval(),

      // 受限的 fetch
      fetch: this.createSafeFetch(manifest.prismax.permissions),

      // 禁止的 API
      process: undefined,
      require: undefined,
      __dirname: undefined,
      __filename: undefined,
    };

    return sandbox;
  }

  private createSafeFetch(permissions: string[]) {
    if (!permissions.includes('network')) {
      return undefined;
    }

    return async (url: string, options?: RequestInit) => {
      // 检查 URL 白名单
      if (!this.isAllowedUrl(url)) {
        throw new Error(`Network access to ${url} is not allowed`);
      }

      return fetch(url, options);
    };
  }

  private isAllowedUrl(url: string): boolean {
    // 检查 URL 是否在白名单中
    const allowedDomains = [
      'api.openai.com',
      'api.anthropic.com',
      // ...
    ];

    const urlObj = new URL(url);
    return allowedDomains.some((domain) => urlObj.hostname.endsWith(domain));
  }
}
```

---

## 插件注册表

```typescript
// plugins/registry.ts
class PluginRegistry {
  private tools: Map<string, ToolDefinition> = new Map();
  private modelProviders: Map<string, ModelProviderDefinition> = new Map();
  private uiExtensions: Map<string, UIExtension[]> = new Map();

  // 工具注册
  registerTool(pluginName: string, tool: ToolDefinition): void {
    const key = `${pluginName}:${tool.name}`;
    this.tools.set(key, tool);
  }

  getTool(name: string): ToolDefinition | undefined {
    return this.tools.get(name);
  }

  getAllTools(): ToolDefinition[] {
    return Array.from(this.tools.values());
  }

  // 模型提供商注册
  registerModelProvider(
    pluginName: string,
    provider: ModelProviderDefinition
  ): void {
    this.modelProviders.set(provider.id, provider);
  }

  getModelProvider(id: string): ModelProviderDefinition | undefined {
    return this.modelProviders.get(id);
  }

  // UI 扩展注册
  registerUIExtension(pluginName: string, extension: UIExtension): void {
    const extensions = this.uiExtensions.get(extension.slot) || [];
    extensions.push(extension);
    extensions.sort((a, b) => (b.priority || 0) - (a.priority || 0));
    this.uiExtensions.set(extension.slot, extensions);
  }

  getUIExtensions(slot: string): UIExtension[] {
    return this.uiExtensions.get(slot) || [];
  }
}
```

---

## 内置插件

### Web 搜索插件

```typescript
// 提供 web_search 工具
{
  name: 'web_search',
  description: 'Search the web for current information',
  parameters: {
    query: { type: 'string', description: 'Search query' },
    maxResults: { type: 'number', default: 5 }
  }
}
```

### URL 抓取插件

```typescript
// 提供 url_fetch 工具
{
  name: 'url_fetch',
  description: 'Fetch and parse content from a URL',
  parameters: {
    url: { type: 'string', description: 'URL to fetch' }
  }
}
```

### 代码执行插件

```typescript
// 提供 code_interpreter 工具
{
  name: 'code_interpreter',
  description: 'Execute Python code in a sandboxed environment',
  parameters: {
    code: { type: 'string', description: 'Python code to execute' }
  }
}
```

---

## 插件开发指南

### 创建插件项目

```bash
# 使用脚手架创建
npx create-prismax-plugin my-plugin

# 项目结构
my-plugin/
├── src/
│   ├── index.ts        # 插件入口
│   └── SettingsPage.tsx # 设置页面（可选）
├── manifest.json       # 插件清单
├── package.json
└── tsconfig.json
```

### 开发调试

```bash
# 启动开发模式
pnpm dev

# 在 PrismaX 中加载开发插件
# 设置 -> 插件 -> 加载本地插件 -> 选择插件目录
```

### 发布插件

```bash
# 构建
pnpm build

# 打包
pnpm pack

# 发布到插件市场（未来功能）
pnpm publish
```

---

## 插件市场（规划中）

### 功能

- 浏览和搜索插件
- 一键安装/卸载
- 自动更新
- 评分和评论
- 开发者认证

### 安全审核

- 代码审查
- 权限审核
- 恶意行为检测
- 签名验证
