# 系统架构

> 本文档描述 PrismaX 的系统架构设计

---

## 分层架构

### 1. 用户界面层 (UI Layer)

**位置**: `packages/ui/` + `apps/*/components/`

**职责**:
- 渲染用户界面
- 处理用户交互
- 响应式布局

**技术选型**:
- React 19 + TypeScript
- shadcn/ui + Radix UI
- Tailwind CSS
- Framer Motion（动画）

**组件分类**:
```
packages/ui/
├── components/
│   ├── chat/              # 聊天相关组件
│   │   ├── ChatInput.tsx
│   │   ├── ChatMessage.tsx
│   │   ├── ChatList.tsx
│   │   └── ...
│   │
│   ├── knowledge/         # 知识库相关组件
│   │   ├── FileUpload.tsx
│   │   ├── DocumentList.tsx
│   │   └── ...
│   │
│   ├── settings/          # 设置相关组件
│   │   ├── ModelConfig.tsx
│   │   ├── ThemeSwitch.tsx
│   │   └── ...
│   │
│   └── common/            # 通用组件
│       ├── Button.tsx
│       ├── Input.tsx
│       ├── Modal.tsx
│       └── ...
```

---

### 2. 状态管理层 (State Layer)

**位置**: `packages/core/stores/`

**职责**:
- 管理应用状态
- 处理状态变更
- 状态持久化

**技术选型**:
- Zustand
- Immer（不可变数据更新）
- zustand/middleware（持久化）

**Store 设计**:
```typescript
// 聊天状态
interface ChatStore {
  conversations: Conversation[];
  activeConversationId: string | null;
  messages: Record<string, Message[]>;

  // Actions
  createConversation: () => void;
  sendMessage: (content: string) => Promise<void>;
  deleteConversation: (id: string) => void;
}

// 设置状态
interface SettingsStore {
  theme: 'light' | 'dark' | 'system';
  language: string;
  defaultModel: string;

  // Actions
  setTheme: (theme: Theme) => void;
  setLanguage: (lang: string) => void;
}

// 知识库状态
interface KnowledgeStore {
  knowledgeBases: KnowledgeBase[];
  documents: Record<string, Document[]>;

  // Actions
  createKnowledgeBase: (name: string) => Promise<void>;
  uploadDocument: (kbId: string, file: File) => Promise<void>;
}
```

---

### 3. 核心业务逻辑层 (Core Layer)

**位置**: `packages/core/`

**职责**:
- 封装业务逻辑
- 平台无关的核心功能
- 数据处理和转换

**模块划分**:
```
packages/core/
├── chat/                  # 聊天核心逻辑
│   ├── conversation.ts    # 会话管理
│   ├── message.ts         # 消息处理
│   └── streaming.ts       # 流式响应处理
│
├── knowledge/             # 知识库核心逻辑
│   ├── embedding.ts       # 向量化处理
│   ├── retrieval.ts       # 检索逻辑
│   └── chunking.ts        # 文档分块
│
├── agent/                 # Agent 核心逻辑
│   ├── runtime.ts         # Agent 运行时
│   ├── tools.ts           # 工具定义
│   └── planning.ts        # 任务规划
│
├── mcp/                   # MCP 协议实现
│   ├── client.ts          # MCP 客户端
│   ├── server.ts          # MCP 服务端
│   └── protocol.ts        # 协议定义
│
└── plugins/               # 插件系统
    ├── loader.ts          # 插件加载器
    ├── registry.ts        # 插件注册表
    └── types.ts           # 插件类型定义
```

---

### 4. AI SDK 层 (AI Layer)

**位置**: `packages/ai-sdk/`

**职责**:
- 统一的 AI 模型调用接口
- 多模型提供商支持
- 流式响应处理

**支持的模型提供商**:
```
packages/ai-sdk/
├── providers/
│   ├── openai/            # OpenAI (GPT-4, GPT-3.5)
│   ├── anthropic/         # Anthropic (Claude)
│   ├── google/            # Google (Gemini)
│   ├── qwen/              # 阿里通义千问
│   ├── deepseek/          # DeepSeek
│   ├── ollama/            # Ollama (本地模型)
│   ├── openrouter/        # OpenRouter (聚合)
│   └── custom/            # 自定义 OpenAI 兼容端点
```

**统一接口设计**:
```typescript
interface AIProvider {
  // 基础对话
  chat(messages: Message[], options?: ChatOptions): Promise<ChatResponse>;

  // 流式对话
  chatStream(messages: Message[], options?: ChatOptions): AsyncIterable<ChatChunk>;

  // 向量化
  embed(texts: string[], options?: EmbedOptions): Promise<number[][]>;

  // 模型列表
  listModels(): Promise<Model[]>;
}
```

---

### 5. 数据存储层 (Storage Layer)

#### 5.1 桌面版存储

**技术选型**:
- SQLite (better-sqlite3) - 结构化数据
- 本地文件系统 - 文件存储
- electron-store - 配置存储

#### 5.2 Web 版存储

**技术选型**:
- PostgreSQL + pgvector - 结构化数据 + 向量搜索
- Redis - 缓存 + Agent 状态
- 本地文件系统 / S3 - 文件存储

---

### 6. 平台适配层 (Platform Layer)

#### 6.1 桌面版适配 (Electron)

```
apps/desktop/
├── main/                  # 主进程
│   ├── index.ts           # 入口
│   ├── window.ts          # 窗口管理
│   ├── ipc.ts             # IPC 通信
│   ├── tray.ts            # 系统托盘
│   ├── updater.ts         # 自动更新
│   └── database.ts        # SQLite 操作
│
├── preload/               # 预加载脚本
│   └── index.ts           # 暴露安全 API
│
└── renderer/              # 渲染进程 (Next.js)
```

**IPC 通信设计**:
```typescript
// preload/index.ts
contextBridge.exposeInMainWorld('electron', {
  // 数据库操作
  db: {
    query: (sql: string, params?: any[]) =>
      ipcRenderer.invoke('db:query', sql, params),
    run: (sql: string, params?: any[]) =>
      ipcRenderer.invoke('db:run', sql, params),
  },

  // 文件操作
  fs: {
    readFile: (path: string) =>
      ipcRenderer.invoke('fs:readFile', path),
    writeFile: (path: string, data: any) =>
      ipcRenderer.invoke('fs:writeFile', path, data),
    selectFile: (options?: any) =>
      ipcRenderer.invoke('fs:selectFile', options),
  },

  // 系统操作
  system: {
    getAppPath: () => ipcRenderer.invoke('system:getAppPath'),
    openExternal: (url: string) =>
      ipcRenderer.invoke('system:openExternal', url),
  },
});
```

#### 6.2 Web 版适配 (Next.js)

```
apps/web/
├── app/                   # App Router
│   ├── (auth)/            # 认证相关页面
│   ├── (main)/            # 主应用页面
│   ├── api/               # API 路由
│   └── layout.tsx         # 根布局
│
├── server/                # 服务端逻辑
│   ├── routers/           # tRPC 路由
│   ├── services/          # 业务服务
│   └── middleware/        # 中间件
│
└── lib/                   # 工具库
```

---

## 数据流设计

### 聊天消息流

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  用户    │───▶│  UI层   │───▶│ Store层 │───▶│ Core层  │───▶│ AI SDK  │
│  输入    │    │ 组件    │    │ Action  │    │ 处理    │    │ 调用    │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └────┬────┘
                                                                  │
                                                                  ▼
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  UI     │◀───│ Store层 │◀───│ Core层  │◀───│ 流式    │◀───│ AI 模型 │
│  更新    │    │ 更新    │    │ 解析    │    │ 响应    │    │ 服务    │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
```

### 知识库检索流

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  用户    │───▶│ 向量化  │───▶│ 相似度  │───▶│ 重排序  │
│  查询    │    │ Query   │    │ 搜索    │    │ Rerank  │
└─────────┘    └─────────┘    └─────────┘    └────┬────┘
                                                  │
                                                  ▼
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  AI     │◀───│ Prompt  │◀───│ 上下文  │◀───│ Top-K   │
│  回答    │    │ 构建    │    │ 组装    │    │ 结果    │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
```

---

## 部署架构

### 桌面版部署

```
┌─────────────────────────────────────────┐
│           用户电脑                       │
│  ┌───────────────────────────────────┐  │
│  │         PrismaX Desktop           │  │
│  │  ┌─────────────┐ ┌─────────────┐  │  │
│  │  │  Electron   │ │   SQLite    │  │  │
│  │  │  主进程     │ │   数据库    │  │  │
│  │  └─────────────┘ └─────────────┘  │  │
│  │  ┌─────────────┐ ┌─────────────┐  │  │
│  │  │  Chromium   │ │  本地文件   │  │  │
│  │  │  渲染进程   │ │   存储      │  │  │
│  │  └─────────────┘ └─────────────┘  │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│         外部 AI 服务                     │
│  • OpenAI API                           │
│  • Claude API                           │
│  • 本地 Ollama                          │
└─────────────────────────────────────────┘
```

### Web 版部署 (Docker)

```
┌─────────────────────────────────────────────────────────────┐
│                     Docker Compose                           │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                   prismax-web                        │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │    │
│  │  │  Next.js    │ │   tRPC      │ │  静态文件   │   │    │
│  │  │  App        │ │   API       │ │   服务      │   │    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘   │    │
│  └─────────────────────────────────────────────────────┘    │
│                          │                                   │
│         ┌────────────────┼────────────────┐                 │
│         ▼                ▼                ▼                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ PostgreSQL  │  │    Redis    │  │  本地存储   │         │
│  │  (pgvector) │  │             │  │  (Volume)   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 安全设计

### 认证与授权

**Web 版**:
- Better Auth 实现用户认证
- JWT Token 会话管理
- 基于角色的访问控制 (RBAC)

**桌面版**:
- 可选的本地密码保护
- 数据加密存储

### 数据安全

- API Key 加密存储
- 敏感数据不记录日志
- HTTPS 强制（Web 版）

### 输入验证

- Zod Schema 验证所有输入
- SQL 注入防护（ORM 参数化查询）
- XSS 防护（React 自动转义）

---

## 性能优化

### 前端优化

- React Server Components（减少客户端 JS）
- 代码分割（动态导入）
- 图片优化（next/image）
- 虚拟列表（长消息列表）

### 后端优化

- 数据库连接池
- Redis 缓存热点数据
- 流式响应（减少首字节时间）
- 向量搜索索引（HNSW）

### 桌面版优化

- 懒加载模块
- 本地缓存
- 后台预加载
