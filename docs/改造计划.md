# PrismaX-Desktop 项目改造计划

> 从 Monorepo (Web + Desktop) 改造为纯桌面端应用 (Electron + Vite + React)

---

## 改造背景

### 原架构问题

1. **Monorepo 复杂度高**：Web 和 Desktop 分开维护，代码复用率低
2. **Next.js 在桌面端的局限**：Server Components、API Routes 等功能在 Electron 中无法充分利用
3. **开发效率低**：Turbo 构建慢，HMR 延迟高
4. **架构不清晰**：Desktop 端独立实现了简化版页面，与 Web 端功能不一致

### 改造目标

1. **专注桌面端**：打造纯本地 AI 聊天应用
2. **技术栈优化**：Vite 替换 Next.js，提升开发体验
3. **简化架构**：从 Monorepo 改为单一项目
4. **保留核心代码**：复用现有的 UI 组件、ChatService、AI Provider 等

---

## 最终技术栈

### 前端（渲染进程）

| 类别     | 技术选型         | 版本 | 说明                  |
| -------- | ---------------- | ---- | --------------------- |
| 构建工具 | Vite             | 6.x  | 极速 HMR，构建快      |
| UI 框架  | React            | 19.x | 最新版本              |
| 类型系统 | TypeScript       | 5.7+ | 严格模式              |
| 路由     | React Router     | 7.x  | 客户端路由            |
| 状态管理 | Zustand          | 5.x  | 轻量 + persist 中间件 |
| 样式     | Tailwind CSS     | 4.x  | 原子化 CSS            |
| UI 组件  | shadcn/ui        | -    | 可定制、现代设计      |
| 动画     | framer-motion    | -    | 流畅动画              |
| Markdown | react-markdown   | -    | Markdown 渲染         |
| 代码高亮 | rehype-highlight | -    | 语法高亮              |

### 主进程（Electron）

| 类别   | 技术选型         | 版本 | 说明                 |
| ------ | ---------------- | ---- | -------------------- |
| 框架   | Electron         | 33.x | 跨平台桌面应用       |
| 数据库 | better-sqlite3   | 11.x | 高性能本地数据库     |
| ORM    | Drizzle          | -    | 类型安全、轻量       |
| AI SDK | @ai-sdk/openai   | -    | 流式响应支持         |
| 构建   | tsup             | 8.x  | 快速 TypeScript 构建 |
| 打包   | electron-builder | 25.x | 多平台打包           |

### 功能特性

| 功能       | 实现方式                 |
| ---------- | ------------------------ |
| 系统托盘   | Electron Tray API        |
| 检查更新   | 自定义实现（不自动安装） |
| 标签页     | 应用内实现（非多窗口）   |
| 状态持久化 | Zustand persist 中间件   |
| 数据存储   | SQLite 本地数据库        |

---

## 项目结构

### 改造后目录结构

```
prismax-desktop/
├── src/                          # 渲染进程（Vite + React）
│   ├── components/               # UI 组件
│   │   ├── chat/                 # 聊天组件（从 packages/ui 迁移）
│   │   │   ├── ChatInput.tsx
│   │   │   ├── MessageList.tsx
│   │   │   ├── MessageBubble.tsx
│   │   │   └── MarkdownRenderer.tsx
│   │   ├── sidebar/              # 侧边栏组件
│   │   │   ├── ConversationList.tsx
│   │   │   └── Sidebar.tsx
│   │   ├── tabs/                 # 标签页组件
│   │   │   ├── TabBar.tsx
│   │   │   └── TabContent.tsx
│   │   ├── settings/             # 设置组件
│   │   └── ui/                   # shadcn/ui 基础组件
│   │       ├── button.tsx
│   │       ├── input.tsx
│   │       ├── dialog.tsx
│   │       └── ...
│   │
│   ├── pages/                    # 页面组件
│   │   ├── Chat.tsx              # 聊天页面
│   │   ├── Settings.tsx          # 设置页面
│   │   └── Welcome.tsx           # 欢迎页面
│   │
│   ├── hooks/                    # 自定义 Hooks
│   │   ├── use-chat.ts           # 聊天 Hook
│   │   ├── use-ipc.ts            # IPC 通信 Hook
│   │   └── use-theme.ts          # 主题 Hook
│   │
│   ├── stores/                   # Zustand 状态管理
│   │   ├── chat.ts               # 聊天状态
│   │   ├── settings.ts           # 设置状态
│   │   ├── tabs.ts               # 标签页状态
│   │   └── index.ts
│   │
│   ├── lib/                      # 工具函数
│   │   ├── ipc.ts                # IPC 客户端封装
│   │   ├── utils.ts              # 通用工具
│   │   └── cn.ts                 # className 合并
│   │
│   ├── types/                    # 类型定义
│   │   ├── chat.ts
│   │   ├── electron.d.ts
│   │   └── index.ts
│   │
│   ├── styles/                   # 样式文件
│   │   └── globals.css
│   │
│   ├── App.tsx                   # 根组件
│   ├── main.tsx                  # 入口文件
│   └── router.tsx                # 路由配置
│
├── electron/                     # 主进程
│   ├── main.ts                   # 主进程入口
│   ├── preload.ts                # 预加载脚本
│   │
│   ├── ipc/                      # IPC 处理器
│   │   ├── index.ts              # IPC 注册
│   │   ├── chat.ts               # 聊天相关 IPC
│   │   ├── database.ts           # 数据库操作 IPC
│   │   └── system.ts             # 系统功能 IPC
│   │
│   ├── services/                 # 业务服务（从 packages 迁移）
│   │   ├── chat-service.ts       # 聊天服务
│   │   ├── ai-provider.ts        # AI Provider
│   │   └── database.ts           # 数据库服务
│   │
│   ├── db/                       # 数据库
│   │   ├── schema.ts             # Drizzle Schema
│   │   ├── migrations/           # 数据库迁移
│   │   └── index.ts
│   │
│   ├── tray.ts                   # 系统托盘
│   ├── updater.ts                # 更新检查
│   └── window.ts                 # 窗口管理
│
├── resources/                    # 资源文件
│   └── icons/                    # 应用图标
│       ├── icon.icns             # macOS
│       ├── icon.ico              # Windows
│       └── icon.png              # Linux
│
├── index.html                    # HTML 入口
├── vite.config.ts                # Vite 配置
├── electron-builder.json         # 打包配置
├── tsconfig.json                 # TypeScript 配置
├── tsconfig.node.json            # Node TypeScript 配置
├── tailwind.config.js            # Tailwind 配置
├── postcss.config.js             # PostCSS 配置
├── package.json
└── README.md
```

---

## 改造步骤

### Phase 1：项目初始化（预计 1 小时）

1. **备份现有代码**

   ```bash
   git checkout -b backup/monorepo-architecture
   git push origin backup/monorepo-architecture
   ```

2. **清理不需要的文件**
   - 删除 `apps/web/`
   - 删除 `apps/desktop/renderer/`（Next.js 渲染进程）
   - 删除 `turbo.json`
   - 删除 `pnpm-workspace.yaml`

3. **重组项目结构**
   - 将 `apps/desktop/electron/` 移动到根目录 `electron/`
   - 创建 `src/` 目录用于渲染进程

### Phase 2：配置 Vite + React（预计 30 分钟）

1. **安装依赖**

   ```bash
   pnpm add react react-dom react-router-dom zustand framer-motion
   pnpm add -D vite @vitejs/plugin-react typescript @types/react @types/react-dom
   ```

2. **配置 Vite**
   - 创建 `vite.config.ts`
   - 配置路径别名
   - 配置构建输出

3. **配置 Tailwind CSS**
   - 安装 Tailwind CSS 4
   - 配置 `tailwind.config.js`

### Phase 3：迁移 UI 组件（预计 1 小时）

1. **迁移聊天组件**
   - `packages/ui/src/components/chat/*` → `src/components/chat/`
   - 移除 `"use client"` 指令（Vite 不需要）

2. **安装 shadcn/ui**

   ```bash
   pnpm dlx shadcn@latest init
   pnpm dlx shadcn@latest add button input dialog
   ```

3. **创建页面组件**
   - 创建 `src/pages/Chat.tsx`
   - 创建 `src/pages/Settings.tsx`

### Phase 4：迁移核心服务（预计 1 小时）

1. **迁移 ChatService**
   - `packages/core/src/services/ChatService.ts` → `electron/services/chat-service.ts`

2. **迁移 AI Provider**
   - `packages/ai-sdk/src/*` → `electron/services/ai-provider.ts`

3. **迁移数据库层**
   - `packages/database/src/desktop/*` → `electron/db/`

### Phase 5：配置 Electron（预计 1 小时）

1. **更新主进程代码**
   - 修改 `electron/main.ts` 加载 Vite 开发服务器
   - 配置系统托盘
   - 配置更新检查

2. **配置 IPC 通信**
   - 整理 IPC 处理器
   - 更新 preload 脚本

3. **配置打包**
   - 创建 `electron-builder.json`
   - 配置多平台打包

### Phase 6：状态管理（预计 30 分钟）

1. **创建 Zustand Stores**
   - 聊天状态 + 持久化
   - 设置状态 + 持久化
   - 标签页状态

2. **配置持久化中间件**
   ```typescript
   import { persist } from "zustand/middleware";
   ```

### Phase 7：测试和优化（预计 1 小时）

1. **功能测试**
   - 聊天功能
   - 数据持久化
   - 系统托盘
   - 更新检查

2. **性能优化**
   - 构建优化
   - 启动速度优化

---

## 代码迁移映射

| 原位置                                      | 新位置                              | 说明         |
| ------------------------------------------- | ----------------------------------- | ------------ |
| `packages/ui/src/components/chat/*`         | `src/components/chat/`              | UI 组件      |
| `packages/core/src/services/ChatService.ts` | `electron/services/chat-service.ts` | 聊天服务     |
| `packages/ai-sdk/src/*`                     | `electron/services/ai-provider.ts`  | AI Provider  |
| `packages/database/src/desktop/*`           | `electron/db/`                      | 数据库层     |
| `apps/desktop/electron/*`                   | `electron/`                         | 主进程代码   |
| `apps/desktop/renderer/src/hooks/*`         | `src/hooks/`                        | 自定义 Hooks |

---

## 删除清单

### 需要删除的目录

```
apps/web/                    # Web 应用
apps/desktop/renderer/       # Next.js 渲染进程
packages/database/src/web/   # Web 数据库 schema
.turbo/                      # Turbo 缓存
```

### 需要删除的文件

```
turbo.json                   # Turbo 配置
pnpm-workspace.yaml          # Monorepo 配置
```

### 需要更新的文件

```
package.json                 # 移除 turbo，更新脚本
tsconfig.json                # 更新路径配置
README.md                    # 更新项目说明
```

---

## 风险评估

| 风险         | 影响 | 缓解措施                    |
| ------------ | ---- | --------------------------- |
| 代码迁移遗漏 | 中   | 逐步迁移，充分测试          |
| 依赖冲突     | 低   | 清理 node_modules，重新安装 |
| 功能回归     | 中   | 保留原分支，可随时回滚      |
| 构建配置问题 | 低   | 参考成熟项目配置            |

---

## 时间估算

| 阶段                       | 预计时间      |
| -------------------------- | ------------- |
| Phase 1：项目初始化        | 1 小时        |
| Phase 2：配置 Vite + React | 30 分钟       |
| Phase 3：迁移 UI 组件      | 1 小时        |
| Phase 4：迁移核心服务      | 1 小时        |
| Phase 5：配置 Electron     | 1 小时        |
| Phase 6：状态管理          | 30 分钟       |
| Phase 7：测试和优化        | 1 小时        |
| **总计**                   | **约 6 小时** |

---

## 后续计划

1. **功能完善**
   - 会话管理
   - 多 AI Provider 支持
   - 知识库功能
   - 插件系统

2. **体验优化**
   - 主题切换
   - 快捷键支持
   - 国际化

3. **发布准备**
   - 应用签名
   - 自动更新服务
   - 官网和文档
