# 系统架构

> 本文档描述 PrismaX-Desktop 桌面应用的系统架构设计

---

## 架构概述

PrismaX-Desktop 采用 Electron 双进程架构，主进程负责系统集成和业务逻辑，渲染进程负责用户界面。

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PrismaX Desktop                               │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      主进程 (Main Process)                    │   │
│  │                                                             │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌──────────┐ │   │
│  │  │  窗口管理  │  │ 系统托盘  │  │ 更新检查  │  │ 文件系统 │ │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └──────────┘ │   │
│  │                                                             │   │
│  │  ┌───────────────────────────────────────────────────────┐ │   │
│  │  │                    业务服务层                          │ │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │ │   │
│  │  │  │ ChatService │  │ AI Provider │  │  Database   │   │ │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘   │ │   │
│  │  └───────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │ IPC                                  │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    预加载脚本 (Preload)                       │   │
│  │                  contextBridge 安全暴露 API                   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    渲染进程 (Renderer Process)                │   │
│  │                                                             │   │
│  │  ┌───────────────────────────────────────────────────────┐ │   │
│  │  │                    Vite + React                        │ │   │
│  │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │ │   │
│  │  │  │  Pages  │  │Components│  │  Hooks  │  │ Stores  │  │ │   │
│  │  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │ │   │
│  │  └───────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 分层架构

### 1. 用户界面层 (UI Layer)

**位置**: `src/`

**职责**:

- 渲染用户界面
- 处理用户交互
- 响应式布局

**技术栈**:

- React 19 + TypeScript
- shadcn/ui
- Tailwind CSS
- Framer Motion (动画)

**组件分类**:

```
src/
├── components/
│   ├── chat/              # 聊天相关组件
│   │   ├── ChatInput.tsx
│   │   ├── MessageList.tsx
│   │   ├── MessageBubble.tsx
│   │   └── MarkdownRenderer.tsx
│   │
│   ├── sidebar/           # 侧边栏组件
│   │   ├── Sidebar.tsx
│   │   └── ConversationList.tsx
│   │
│   ├── tabs/              # 标签页组件
│   │   ├── TabBar.tsx
│   │   └── TabContent.tsx
│   │
│   ├── settings/          # 设置组件
│   │   ├── SettingsPanel.tsx
│   │   └── ModelConfig.tsx
│   │
│   └── ui/                # 基础组件 (shadcn/ui)
│       ├── button.tsx
│       ├── input.tsx
│       └── ...
```

---

### 2. 状态管理层 (State Layer)

**位置**: `src/stores/`

**职责**:

- 管理应用状态
- 处理状态变更
- 状态持久化

**技术栈**:

- Zustand
- zustand/middleware (persist)

**Store 设计**:

```typescript
// 聊天状态
interface ChatStore {
  conversations: Conversation[];
  activeConversationId: string | null;
  messages: Record<string, Message[]>;

  // Actions
  createConversation: () => void;
  sendMessage: (content: string) => Promise<void>;
  deleteConversation: (id: string) => void;
}

// 设置状态
interface SettingsStore {
  theme: "light" | "dark" | "system";
  language: string;
  defaultModel: string;
  apiKeys: Record<string, string>;

  // Actions
  setTheme: (theme: Theme) => void;
  setLanguage: (lang: string) => void;
  setApiKey: (provider: string, key: string) => void;
}

// 标签页状态
interface TabsStore {
  tabs: Tab[];
  activeTabId: string | null;

  // Actions
  openTab: (conversationId: string) => void;
  closeTab: (tabId: string) => void;
  setActiveTab: (tabId: string) => void;
}
```

---

### 3. IPC 通信层 (IPC Layer)

**位置**: `electron/ipc/` + `src/lib/ipc.ts`

**职责**:

- 渲染进程与主进程通信
- 安全 API 暴露
- 请求/响应处理

**通信设计**:

```typescript
// electron/preload.ts - 安全暴露 API
contextBridge.exposeInMainWorld("electron", {
  // 聊天
  chat: {
    send: (input: ChatInput) => ipcRenderer.invoke("chat:send", input),
    onToken: (callback: TokenCallback) => {
      const listener = (_: any, token: string) => callback(token);
      ipcRenderer.on("chat:token", listener);
      return () => ipcRenderer.removeListener("chat:token", listener);
    },
    onDone: (callback: DoneCallback) => {
      const listener = (_: any, data: any) => callback(data);
      ipcRenderer.on("chat:done", listener);
      return () => ipcRenderer.removeListener("chat:done", listener);
    },
  },

  // 数据库
  db: {
    getConversations: () => ipcRenderer.invoke("db:getConversations"),
    createConversation: (title: string) => ipcRenderer.invoke("db:createConversation", title),
    deleteConversation: (id: string) => ipcRenderer.invoke("db:deleteConversation", id),
    getMessages: (conversationId: string) => ipcRenderer.invoke("db:getMessages", conversationId),
  },

  // 系统
  system: {
    getAppVersion: () => ipcRenderer.invoke("system:getAppVersion"),
    checkUpdate: () => ipcRenderer.invoke("system:checkUpdate"),
    openExternal: (url: string) => ipcRenderer.invoke("system:openExternal", url),
    minimize: () => ipcRenderer.invoke("system:minimize"),
    close: () => ipcRenderer.invoke("system:close"),
  },
});
```

---

### 4. 业务服务层 (Service Layer)

**位置**: `electron/services/`

**职责**:

- 封装业务逻辑
- 平台无关的核心功能
- 数据处理和转换

**服务设计**:

```typescript
// ChatService - 聊天服务
class ChatService {
  constructor(
    private readonly chatRepository: IChatRepository,
    private readonly aiProvider: IAIProvider,
  ) {}

  async sendMessage(input: SendMessageInput): Promise<SendMessageResult> {
    // 1. 保存用户消息
    // 2. 获取历史上下文
    // 3. 调用 AI API
    // 4. 流式返回响应
    // 5. 保存助手消息
  }
}

// AIProvider - AI 提供商抽象
interface IAIProvider {
  chat(messages: Message[], options?: ChatOptions): Promise<ChatResponse>;
  chatStream(messages: Message[], options?: ChatOptions): AsyncIterable<string>;
  listModels(): Promise<Model[]>;
}
```

---

### 5. 数据存储层 (Storage Layer)

**位置**: `electron/db/`

**职责**:

- 本地数据持久化
- 数据库操作封装
- 数据迁移管理

**技术栈**:

- SQLite (better-sqlite3)
- Drizzle ORM

**Schema 设计**:

```typescript
// 会话表
export const conversations = sqliteTable("conversations", {
  id: text("id").primaryKey(),
  title: text("title"),
  createdAt: integer("created_at", { mode: "timestamp" }).notNull(),
  updatedAt: integer("updated_at", { mode: "timestamp" }).notNull(),
});

// 消息表
export const messages = sqliteTable("messages", {
  id: text("id").primaryKey(),
  conversationId: text("conversation_id")
    .notNull()
    .references(() => conversations.id),
  role: text("role").notNull(), // 'user' | 'assistant' | 'system'
  content: text("content").notNull(),
  createdAt: integer("created_at", { mode: "timestamp" }).notNull(),
});

// 设置表
export const settings = sqliteTable("settings", {
  key: text("key").primaryKey(),
  value: text("value").notNull(),
});
```

---

## 数据流设计

### 聊天消息流

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  用户   │───▶│   UI    │───▶│  Store  │───▶│   IPC   │───▶│ Service │
│  输入   │    │  组件   │    │  Action │    │  调用   │    │  处理   │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └────┬────┘
                                                                  │
                                                                  ▼
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│   UI    │◀───│  Store  │◀───│   IPC   │◀───│  流式   │◀───│ AI API  │
│  更新   │    │  更新   │    │  事件   │    │  响应   │    │  调用   │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
```

### 设置变更流

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  用户   │───▶│  Store  │───▶│   IPC   │───▶│ Database│
│  操作   │    │  更新   │    │  保存   │    │  持久化 │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
                   │
                   ▼
              ┌─────────┐
              │ persist │
              │ 中间件  │
              └─────────┘
```

---

## 安全设计

### 进程隔离

```
┌─────────────────────────────────────────────────────────────┐
│                      渲染进程 (沙箱)                         │
│  • 无法直接访问 Node.js API                                 │
│  • 无法直接访问文件系统                                      │
│  • 只能通过 contextBridge 暴露的 API 与主进程通信            │
└─────────────────────────────────────────────────────────────┘
                              │
                    contextBridge (安全桥接)
                              │
┌─────────────────────────────────────────────────────────────┐
│                      主进程 (完全权限)                       │
│  • 可以访问 Node.js API                                     │
│  • 可以访问文件系统                                          │
│  • 可以访问数据库                                            │
│  • 可以发起网络请求                                          │
└─────────────────────────────────────────────────────────────┘
```

### API Key 安全

- API Key 存储在主进程的 SQLite 数据库中
- 渲染进程无法直接访问 API Key
- 所有 AI 请求通过主进程发起

### 输入验证

- 所有 IPC 输入使用 Zod 进行验证
- 防止 SQL 注入（ORM 参数化查询）
- 防止 XSS（React 自动转义）

---

## 性能优化

### 渲染进程优化

- 虚拟列表（长消息列表）
- 代码分割（动态导入）
- 图片懒加载
- Memo 优化（避免不必要的重渲染）

### 主进程优化

- 数据库连接复用
- 流式响应（减少首字节时间）
- 后台预加载

### 启动优化

- 延迟加载非关键模块
- 预编译 SQLite 查询
- 窗口预热

---

## 系统托盘

```typescript
// electron/tray.ts
import { Tray, Menu, nativeImage } from "electron";

export function createTray(mainWindow: BrowserWindow) {
  const icon = nativeImage.createFromPath("resources/icons/tray.png");
  const tray = new Tray(icon);

  const contextMenu = Menu.buildFromTemplate([
    { label: "显示窗口", click: () => mainWindow.show() },
    {
      label: "新建会话",
      click: () => {
        /* ... */
      },
    },
    { type: "separator" },
    {
      label: "检查更新",
      click: () => {
        /* ... */
      },
    },
    {
      label: "设置",
      click: () => {
        /* ... */
      },
    },
    { type: "separator" },
    { label: "退出", click: () => app.quit() },
  ]);

  tray.setToolTip("PrismaX-Desktop");
  tray.setContextMenu(contextMenu);

  // 点击托盘图标显示窗口
  tray.on("click", () => {
    mainWindow.isVisible() ? mainWindow.hide() : mainWindow.show();
  });

  return tray;
}
```

---

## 更新检查

```typescript
// electron/updater.ts
import { dialog, shell } from "electron";

interface UpdateInfo {
  version: string;
  releaseNotes: string;
  downloadUrl: string;
}

export async function checkForUpdates(): Promise<UpdateInfo | null> {
  try {
    const response = await fetch("https://api.github.com/repos/xxx/prismax/releases/latest");
    const release = await response.json();

    const currentVersion = app.getVersion();
    const latestVersion = release.tag_name.replace("v", "");

    if (latestVersion > currentVersion) {
      return {
        version: latestVersion,
        releaseNotes: release.body,
        downloadUrl: release.html_url,
      };
    }

    return null;
  } catch (error) {
    console.error("检查更新失败:", error);
    return null;
  }
}

export async function promptUpdate(updateInfo: UpdateInfo) {
  const result = await dialog.showMessageBox({
    type: "info",
    title: "发现新版本",
    message: `新版本 ${updateInfo.version} 可用`,
    detail: updateInfo.releaseNotes,
    buttons: ["前往下载", "稍后提醒"],
  });

  if (result.response === 0) {
    shell.openExternal(updateInfo.downloadUrl);
  }
}
```
