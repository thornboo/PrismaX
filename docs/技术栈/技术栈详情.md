# 技术栈详情

> 本文档详细说明 PrismaX-Desktop 桌面应用各层的技术选型

---

## 前端技术栈（渲染进程）

| 类别     | 选型                  | 版本 | 说明                   |
| -------- | --------------------- | ---- | ---------------------- |
| 构建工具 | Vite                  | 6.x  | 极速 HMR，构建快 10 倍 |
| UI 框架  | React                 | 19   | 最新版本               |
| UI 组件  | shadcn/ui             | -    | 高度可定制，无样式锁定 |
| 样式方案 | Tailwind CSS          | 4.x  | 原子化 CSS，开发效率高 |
| 状态管理 | Zustand               | 5.x  | 轻量、TypeScript 友好  |
| 路由     | React Router          | 7.x  | 客户端路由             |
| 表单处理 | React Hook Form + Zod | -    | 类型安全的表单验证     |
| 国际化   | i18next               | -    | 多语言支持             |
| 图标     | Lucide React          | -    | 开源图标库             |
| 动画     | Framer Motion         | -    | 流畅动画效果           |

### 为什么选择 Vite？

| 对比项     | Vite       | Next.js      | Create React App |
| ---------- | ---------- | ------------ | ---------------- |
| HMR 速度   | ⭐⭐⭐⭐⭐ | ⭐⭐⭐       | ⭐⭐             |
| 构建速度   | ⭐⭐⭐⭐⭐ | ⭐⭐⭐       | ⭐⭐             |
| 配置复杂度 | 低         | 中           | 低               |
| 桌面端适配 | 原生支持   | 需要额外配置 | 原生支持         |
| 包体积     | 小         | 较大         | 中等             |

**结论**：Vite 在桌面端场景下开发体验最佳。

### 为什么选择 shadcn/ui？

| 对比项   | shadcn/ui  | Ant Design | Material UI |
| -------- | ---------- | ---------- | ----------- |
| 可定制性 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐     | ⭐⭐⭐      |
| 包体积   | ⭐⭐⭐⭐⭐ | ⭐⭐       | ⭐⭐        |
| 样式锁定 | 无         | 有         | 有          |
| 学习曲线 | 低         | 中         | 中          |
| 设计风格 | 现代简约   | 企业风格   | Material    |

---

## 主进程技术栈（Electron）

| 类别   | 选型             | 说明                   |
| ------ | ---------------- | ---------------------- |
| 框架   | Electron 33      | 跨平台桌面应用         |
| 数据库 | better-sqlite3   | 高性能本地 SQLite      |
| ORM    | Drizzle          | 类型安全、轻量、高性能 |
| AI SDK | @ai-sdk/openai   | 流式响应处理           |
| 构建   | tsup             | 快速 TypeScript 构建   |
| 打包   | electron-builder | 多平台打包             |

### 为什么选择 Drizzle ORM？

| 对比项   | Drizzle    | Prisma     | TypeORM  |
| -------- | ---------- | ---------- | -------- |
| 性能     | ⭐⭐⭐⭐⭐ | ⭐⭐⭐     | ⭐⭐⭐   |
| 类型安全 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐   |
| 包体积   | ⭐⭐⭐⭐⭐ | ⭐⭐       | ⭐⭐⭐   |
| SQL 控制 | 完全控制   | 抽象化     | 部分控制 |
| 学习曲线 | 低         | 低         | 中       |

---

## Electron 架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Electron 应用                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    主进程 (Main)                      │   │
│  │  • 窗口管理                                          │   │
│  │  • 系统托盘                                          │   │
│  │  • 本地数据库 (SQLite)                               │   │
│  │  • 文件系统操作                                      │   │
│  │  • AI API 调用                                       │   │
│  │  • 更新检查                                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │ IPC                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                  预加载脚本 (Preload)                 │   │
│  │  • 安全 API 暴露                                     │   │
│  │  • contextBridge                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                  渲染进程 (Renderer)                  │   │
│  │  • Vite + React 应用                                │   │
│  │  • UI 组件                                          │   │
│  │  • 用户界面                                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## IPC 通信设计

```typescript
// 约定：所有 invoke/handle 返回统一包裹为 IpcResponse<T>
type IpcResponse<T> =
  | { success: true; data: T; error: null }
  | { success: false; data: null; error: string };

// 预加载脚本只做安全桥接（通道名来自 electron/ipc/channels.ts）
import { IPC_CHANNELS } from "./ipc/channels";
contextBridge.exposeInMainWorld("electron", {
  db: {
    getConversations: () => ipcRenderer.invoke(IPC_CHANNELS.db.getConversations),
  },
  chat: {
    send: (input: { conversationId: string; content: string }) =>
      ipcRenderer.invoke(IPC_CHANNELS.chat.send, input) as Promise<
        IpcResponse<{ requestId: string }>
      >,
  },
});

// 渲染进程调用：按 success 分支处理，不依赖 try/catch
const res = await window.electron.chat.send({ conversationId, content });
if (!res.success) {
  alert(res.error);
  return;
}
console.log(res.data.requestId);
```

---

## AI 技术栈

| 类别       | 选型           | 说明                    |
| ---------- | -------------- | ----------------------- |
| AI SDK     | @ai-sdk/openai | Vercel AI SDK，流式响应 |
| 本地模型   | Ollama         | 本地 LLM 运行时         |
| 向量数据库 | SQLite + 扩展  | 本地向量存储（规划中）  |

### 支持的模型提供商

```
providers/
├── openai/            # OpenAI (GPT-4, GPT-3.5)
├── anthropic/         # Anthropic (Claude)
├── google/            # Google (Gemini)
├── qwen/              # 阿里通义千问
├── deepseek/          # DeepSeek
├── ollama/            # Ollama (本地模型)
└── custom/            # 自定义 OpenAI 兼容端点
```

---

## 开发工具链

| 类别      | 选型                | 说明               |
| --------- | ------------------- | ------------------ |
| 包管理器  | pnpm                | 快速，节省磁盘空间 |
| 代码规范  | ESLint + Prettier   | 统一代码风格       |
| 类型检查  | TypeScript 5.7+     | 严格模式           |
| 测试      | Vitest              | 单元测试           |
| Git Hooks | Husky + lint-staged | 提交前检查         |

---

## 状态管理设计

### Zustand + Persist

```typescript
import { create } from "zustand";
import { persist } from "zustand/middleware";

// 聊天状态（持久化）
interface ChatStore {
  conversations: Conversation[];
  activeConversationId: string | null;

  // Actions
  createConversation: () => void;
  setActiveConversation: (id: string) => void;
  deleteConversation: (id: string) => void;
}

export const useChatStore = create<ChatStore>()(
  persist(
    (set) => ({
      conversations: [],
      activeConversationId: null,

      createConversation: () => {
        // ...
      },
      // ...
    }),
    {
      name: "chat-storage",
    },
  ),
);

// 设置状态（持久化）
interface SettingsStore {
  theme: "light" | "dark" | "system";
  language: string;
  defaultModel: string;

  // Actions
  setTheme: (theme: Theme) => void;
  setLanguage: (lang: string) => void;
}

export const useSettingsStore = create<SettingsStore>()(
  persist(
    (set) => ({
      theme: "system",
      language: "zh-CN",
      defaultModel: "gpt-4o-mini",

      setTheme: (theme) => set({ theme }),
      // ...
    }),
    {
      name: "settings-storage",
    },
  ),
);
```

---

## 打包配置

### electron-builder.json

```json
{
  "appId": "com.prismax.desktop",
  "productName": "PrismaX-Desktop",
  "directories": {
    "output": "release"
  },
  "files": ["dist/**/*", "electron-dist/**/*"],
  "mac": {
    "category": "public.app-category.productivity",
    "icon": "resources/icons/icon.icns",
    "target": ["dmg", "zip"]
  },
  "win": {
    "icon": "resources/icons/icon.ico",
    "target": ["nsis", "portable"]
  },
  "linux": {
    "icon": "resources/icons",
    "target": ["AppImage", "deb"]
  },
  "nsis": {
    "oneClick": false,
    "allowToChangeInstallationDirectory": true
  }
}
```
