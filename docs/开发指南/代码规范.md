# 代码规范

> 本文档描述 PrismaX-Desktop 代码风格和规范

---

## 通用规范

### 语言规范

项目采用**英文注释**策略：

| 内容         | 语言要求 | 示例                           |
| ------------ | -------- | ------------------------------ |
| 代码注释     | 英文     | `// Initialize chat state`     |
| TODO/FIXME   | 英文     | `// TODO: Add pagination`      |
| 变量/函数名  | 英文     | `getUserById`, `messageList`   |
| Commit 信息  | 英文     | `feat(chat): add message edit` |
| 文档 (docs/) | 中文     | 面向中文开发者                 |

### 文件命名

| 类型       | 命名规范         | 示例                     |
| ---------- | ---------------- | ------------------------ |
| React 组件 | PascalCase       | `ChatMessage.tsx`        |
| 工具函数   | camelCase        | `formatDate.ts`          |
| 常量文件   | camelCase        | `constants.ts`           |
| 类型定义   | camelCase        | `types.ts`               |
| 样式文件   | 与组件同名       | `ChatMessage.module.css` |
| 测试文件   | 源文件名 + .test | `formatDate.test.ts`     |

### 目录结构

```
src/
├── components/          # React 组件
│   ├── ChatMessage/
│   │   ├── index.tsx    # 组件入口
│   │   ├── ChatMessage.tsx
│   │   ├── ChatMessage.test.tsx
│   │   └── types.ts
│   └── ...
├── hooks/               # 自定义 Hooks
├── lib/                 # 工具库
├── stores/              # 状态管理
├── types/               # 类型定义
└── utils/               # 工具函数
```

---

## TypeScript 规范

### 类型定义

```typescript
// 对象类型使用 interface
interface User {
  id: string;
  name: string;
  email: string;
}

// 联合类型、交叉类型使用 type
type Status = "pending" | "success" | "error";
type UserWithRole = User & { role: string };

// 避免使用 any，使用 unknown 代替
function parseJSON(json: string): unknown {
  return JSON.parse(json);
}

// 使用泛型提高复用性
function getFirst<T>(arr: T[]): T | undefined {
  return arr[0];
}
```

### 命名规范

```typescript
// 接口名使用 PascalCase
interface UserProfile

// 类型别名使用 PascalCase
type MessageType = 'text' | 'image';

// 枚举使用 PascalCase，成员使用 PascalCase
enum MessageRole {
  User = 'user',
  Assistant = 'assistant',
  System = 'system',
}

// 常量使用 UPPER_SNAKE_CASE
const MAX_MESSAGE_LENGTH = 10000;

// 函数和变量使用 camelCase
const getUserById = (id: string) => {};
```

---

## React 规范

### 组件定义

```tsx
// 使用函数组件 + TypeScript
interface ChatMessageProps {
  message: Message;
  onEdit?: (id: string) => void;
  onDelete?: (id: string) => void;
}

export function ChatMessage({ message, onEdit, onDelete }: ChatMessageProps) {
  // 组件逻辑
  return <div>{/* JSX */}</div>;
}

// 使用 forwardRef 时
interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {
  label?: string;
}

export const Input = React.forwardRef<HTMLInputElement, InputProps>(({ label, ...props }, ref) => {
  return (
    <div>
      {label && <label>{label}</label>}
      <input ref={ref} {...props} />
    </div>
  );
});
```

### Hooks 使用

```tsx
// 自定义 Hooks 以 use 开头
function useConversation(id: string) {
  const [conversation, setConversation] = useState<Conversation | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // 加载数据
  }, [id]);

  return { conversation, loading };
}

// 避免在条件语句中使用 Hooks
// 错误
if (condition) {
  const [state, setState] = useState();
}

// 正确
const [state, setState] = useState();
if (condition) {
  // 使用 state
}
```

### 事件处理

```tsx
// 事件处理函数以 handle 开头
function ChatInput() {
  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    // 处理提交
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && !e.shiftKey) {
      handleSubmit(e);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <textarea onKeyDown={handleKeyDown} />
    </form>
  );
}
```

---

## 样式规范

### Tailwind CSS

```tsx
// 使用 Tailwind 类名
<div className="flex items-center gap-4 p-4 bg-white rounded-lg shadow">
  <span className="text-sm text-gray-500">Hello</span>
</div>;

// 使用 cn 工具函数合并类名
import { cn } from "@/lib/utils";

<button
  className={cn(
    "px-4 py-2 rounded-md",
    variant === "primary" && "bg-blue-500 text-white",
    variant === "secondary" && "bg-gray-100 text-gray-900",
    disabled && "opacity-50 cursor-not-allowed",
  )}
>
  点击
</button>;
```

### CSS 变量

```css
/* 使用 CSS 变量实现主题 */
:root {
  --background: 0 0% 100%;
  --foreground: 0 0% 3.9%;
  --primary: 0 0% 9%;
  --primary-foreground: 0 0% 98%;
}

.dark {
  --background: 0 0% 3.9%;
  --foreground: 0 0% 98%;
  --primary: 0 0% 98%;
  --primary-foreground: 0 0% 9%;
}
```

---

## 状态管理规范

### Zustand Store

```typescript
import { create } from "zustand";
import { persist } from "zustand/middleware";

interface ChatStore {
  // 状态
  conversations: Conversation[];
  activeId: string | null;

  // 操作
  setActiveId: (id: string | null) => void;
  addConversation: (conversation: Conversation) => void;
  removeConversation: (id: string) => void;
}

export const useChatStore = create<ChatStore>()(
  persist(
    (set) => ({
      conversations: [],
      activeId: null,

      setActiveId: (id) => set({ activeId: id }),

      addConversation: (conversation) =>
        set((state) => ({
          conversations: [...state.conversations, conversation],
        })),

      removeConversation: (id) =>
        set((state) => ({
          conversations: state.conversations.filter((c) => c.id !== id),
        })),
    }),
    {
      name: "chat-store",
    },
  ),
);
```

---

## 注释规范

**All comments must be in English.**

### 文件头注释

```typescript
/**
 * Chat message component
 *
 * Displays a single chat message with Markdown rendering and code highlighting.
 */
```

### 函数注释

```typescript
/**
 * Format date to relative time string
 *
 * @param date - The date to format
 * @param locale - The locale for formatting, defaults to 'en-US'
 * @returns Formatted relative time string
 *
 * @example
 * formatRelativeTime(new Date()) // 'just now'
 * formatRelativeTime(new Date(Date.now() - 60000)) // '1 minute ago'
 */
function formatRelativeTime(date: Date, locale = "en-US"): string {
  // Implementation
}
```

### TODO 注释

```typescript
// TODO: Implement message pagination
// FIXME: Fix long message performance issue
// NOTE: Using special algorithm here, see documentation
// HACK: Temporary workaround, waiting for upstream fix
```

---

## 测试规范

### 单元测试

```typescript
import { describe, it, expect } from "vitest";
import { formatRelativeTime } from "./formatRelativeTime";

describe("formatRelativeTime", () => {
  it('当前时间应返回"刚刚"', () => {
    const result = formatRelativeTime(new Date());
    expect(result).toBe("刚刚");
  });

  it('1 分钟前应返回"1 分钟前"', () => {
    const date = new Date(Date.now() - 60000);
    const result = formatRelativeTime(date);
    expect(result).toBe("1 分钟前");
  });
});
```

### 组件测试

```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { ChatInput } from './ChatInput';

describe('ChatInput', () => {
  it('提交表单时应调用 onSubmit', () => {
    const onSubmit = vi.fn();
    render(<ChatInput onSubmit={onSubmit} />);

    const input = screen.getByRole('textbox');
    fireEvent.change(input, { target: { value: 'Hello' } });
    fireEvent.submit(input.closest('form')!);

    expect(onSubmit).toHaveBeenCalledWith('Hello');
  });
});
```

---

## ESLint 配置

项目使用以下 ESLint 规则：

```javascript
// eslint.config.js
export default [
  {
    rules: {
      // TypeScript
      "@typescript-eslint/no-unused-vars": "error",
      "@typescript-eslint/no-explicit-any": "warn",

      // React
      "react/prop-types": "off",
      "react/react-in-jsx-scope": "off",
      "react-hooks/rules-of-hooks": "error",
      "react-hooks/exhaustive-deps": "warn",

      // Import
      "import/order": [
        "error",
        {
          groups: ["builtin", "external", "internal", "parent", "sibling"],
          "newlines-between": "always",
        },
      ],
    },
  },
];
```

---

## Prettier 配置

```json
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 100,
  "plugins": ["prettier-plugin-tailwindcss"]
}
```
